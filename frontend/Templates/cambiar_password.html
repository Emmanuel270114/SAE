<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cambiar Contraseña - SAE</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/recuperar_usuario.css">
</head>
<body>
  <div class="auth-box">
    <h2>Cambiar Contraseña</h2>
    <div id="aviso-temporal" class="info-banner warning-info" style="display: none; margin-bottom: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; color: #856404;">
      <p><strong>⚠️ Contraseña Temporal Detectada</strong></p>
      <p>Por seguridad, debes cambiar tu contraseña temporal por una personal antes de continuar.</p>
    </div>
    <form id="form-cambiar-pass">
      <label for="current_password">Contraseña actual</label>
      <input type="password" id="current_password" name="current_password" required minlength="8" class="input-form" placeholder="Ingresa tu contraseña actual" title="Ingresa tu contraseña actual">
      <label for="new_password">Nueva contraseña</label>
      <input type="password" id="new_password" name="new_password" required minlength="8" class="input-form" placeholder="Nueva contraseña" title="Nueva contraseña">
      <label for="new_password2">Repite nueva contraseña</label>
      <input type="password" id="new_password2" name="new_password2" required minlength="8" class="input-form" placeholder="Repite la nueva contraseña" title="Repite la nueva contraseña">
      <button type="submit" class="btn-primary">Actualizar contraseña</button>
    </form>
    <div id="resultado" class="resultado"></div>
    <div class="acciones-secundarias">
      <a href="/mod_principal">Volver al panel</a> |
      <a href="/login">Cerrar sesión</a>
    </div>
  </div>
  <script>
    const formCambiar = document.getElementById('form-cambiar-pass');
    formCambiar.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formCambiar);
      
      // Validar que las contraseñas nuevas coincidan
      const newPass = document.getElementById('new_password').value;
      const newPass2 = document.getElementById('new_password2').value;
      
      if (newPass !== newPass2) {
        document.getElementById('resultado').innerHTML = '<p class="error">Las contraseñas nuevas no coinciden</p>';
        return;
      }
      
      document.getElementById('resultado').innerHTML = '<p class="info">Procesando...</p>';
      
      try {
        const resp = await fetch('/recuperacion/cambiar', { method: 'POST', body: fd });
        const data = await resp.json();
        
        if (resp.ok) {
          document.getElementById('resultado').innerHTML = `<p class='ok'>${data.mensaje}</p>`;
          formCambiar.reset();
          // Redirigir al panel principal después de cambiar contraseña exitosamente
          setTimeout(() => {
            window.location.href = '/mod_principal';
          }, 2000);
        } else {
          document.getElementById('resultado').innerHTML = `<p class='error'>${data.mensaje}</p>`;
        }
      } catch (error) {
        document.getElementById('resultado').innerHTML = '<p class="error">Error de conexión</p>';
      }
    });
    
    // Detectar si viene de contraseña temporal (por el referer o parámetro)
    if (document.referrer.includes('/login') || window.location.search.includes('temporal=true')) {
      document.getElementById('aviso-temporal').style.display = 'block';
    }
  </script>
</body>
</html>

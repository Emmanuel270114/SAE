<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios de mi Unidad Académica</title>
    <link rel="stylesheet" href="/static/css/usuarios.css">
</head>
<body>
    <div class="container">
        <div class="header-usuarios">
            <div class="bienvenido">Bienvenido {{ nombre_usuario }} {{ apellidoP_usuario }} {{ apellidoM_usuario }}</div>
            <form action="/login" method="get">
                <button type="submit" class="btn-volver">Cerrar Sesión</button>
            </form>
        </div>
        <h2>Usuarios de la Unidad Académica: {{ nombre_ua }}</h2>

        <!-- Formulario de registro/edición (mejor diseño, edición y título) -->
        <div class="registro-container">
            <h3>Datos Usuario</h3>
            <form id="registroForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombre">Nombre(s)</label>
                        <input type="text" id="nombre" name="nombre" placeholder="Nombre(s)" required class="input-form">
                    </div>
                    <div class="form-group">
                        <label for="ap_pat">Apellido Paterno</label>
                        <input type="text" id="ap_pat" name="paterno" placeholder="Apellido Paterno" required class="input-form">
                    </div>
                    <div class="form-group">
                        <label for="ap_mat">Apellido Materno</label>
                        <input type="text" id="ap_mat" name="materno" placeholder="Apellido Materno" required class="input-form">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Correo Electrónico</label>
                        <input type="email" id="email" name="email" placeholder="Correo Electrónico" required oninput="sugerirUsuario()" class="input-form">
                    </div>
                    <div class="form-group">
                        <label for="usuario">Usuario</label>
                        <input type="text" id="usuario" name="usuario" placeholder="Usuario Sugerido" required readonly class="input-form input-readonly">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" name="password" placeholder="Contraseña (mínimo 8 caracteres)" minlength="8" required class="input-form">
                    </div>
                    <div class="form-group">
                        <label for="id_unidad_academica">Unidad Académica</label>
                        <select id="id_unidad_academica" name="id_unidad_academica" required class="input-form" title="Selecciona la unidad académica">
                            {% for ua in unidades_academicas %}
                            <option value="{{ ua.Id_Unidad_Academica }}">{{ ua.Sigla }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_rol">Rol</label>
                        <select id="id_rol" name="id_rol" required class="input-form" title="Selecciona el rol">
                            {% for rol in roles %}
                            <option value="{{ rol.Id_Rol }}">{{ rol.Nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <input type="hidden" id="id_usuario" name="id_usuario">
                <div class="form-row">
                    <button type="submit" id="btn-guardar">Registrar</button>
                    <button type="button" id="btn-cancelar" style="display:none;margin-left:10px;">Cancelar</button>
                </div>
            </form>
            <div id="mensaje"></div>
        </div>

        <table id="tabla-usuarios">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Usuario</th>
                    <th>Email</th>
                    <th>Rol</th>
                </tr>
            </thead>
            <tbody>
                {% for u, nombre_rol in usuarios_con_rol %}
                <tr class="fila-usuario" data-id="{{ u.Id_Usuario }}" data-nombre="{{ u.Nombre }}" data-paterno="{{ u.Paterno }}" data-materno="{{ u.Materno }}" data-usuario="{{ u.Usuario }}" data-email="{{ u.Email }}" data-id_unidad="{{ u.Id_Unidad_Academica }}" data-id_rol="{{ u.Id_Rol }}">
                    <td>{{ u.Nombre }} {{ u.Paterno }} {{ u.Materno }}</td>
                    <td>{{ u.Usuario }}</td>
                    <td>{{ u.Email }}</td>
                    <td>{{ nombre_rol }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- CSS externo aplicado -->
        <script>
        function sugerirUsuario() {
            const correo = document.getElementById('email').value.trim();
            let usuario = correo.split('@')[0];
            document.getElementById('usuario').value = usuario;
        }

        // Estado: edición o registro
        let editando = false;
        let idUsuarioEdit = null;

        // Al hacer clic en una fila de usuario, cargar datos en el formulario
        document.querySelectorAll('.fila-usuario').forEach(fila => {
            fila.addEventListener('click', function() {
                editando = true;
                idUsuarioEdit = this.dataset.id;
                document.getElementById('id_usuario').value = this.dataset.id;
                document.getElementById('nombre').value = this.dataset.nombre;
                document.getElementById('ap_pat').value = this.dataset.paterno;
                document.getElementById('ap_mat').value = this.dataset.materno;
                document.getElementById('usuario').value = this.dataset.usuario;
                document.getElementById('email').value = this.dataset.email;
                document.getElementById('id_unidad_academica').value = this.dataset.id_unidad;
                document.getElementById('id_rol').value = this.dataset.id_rol;
                document.getElementById('password').value = '';
                document.getElementById('btn-guardar').textContent = 'Guardar Cambios';
                document.getElementById('btn-cancelar').style.display = 'inline-block';
            });
        });

        // Cancelar edición
        document.getElementById('btn-cancelar').addEventListener('click', function() {
            editando = false;
            idUsuarioEdit = null;
            document.getElementById('registroForm').reset();
            document.getElementById('id_usuario').value = '';
            document.getElementById('btn-guardar').textContent = 'Registrar';
            this.style.display = 'none';
        });

        document.getElementById("registroForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const data = {
                Nombre: document.getElementById("nombre").value,
                Paterno: document.getElementById("ap_pat").value,
                Materno: document.getElementById("ap_mat").value,
                Usuario: document.getElementById("usuario").value,
                Email: document.getElementById("email").value,
                Password: document.getElementById("password").value,
                Id_Unidad_Academica: parseInt(document.getElementById("id_unidad_academica").value),
                Id_Rol: parseInt(document.getElementById("id_rol").value),
                Id_Estatus: 1,
            };
            let url = "/usuarios/registrar";
            if (editando && idUsuarioEdit) {
                url = `/usuarios/editar/${idUsuarioEdit}`;
            }
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok && (result.Id_Usuario || result.mensaje)) {
                    document.getElementById("mensaje").innerHTML = `<p style='color:green;'>${editando ? '✅ Usuario actualizado' : '✅ Usuario registrado con ID ' + result.Id_Usuario}</p>`;
                    setTimeout(() => { location.reload(); }, 1200);
                } else {
                    document.getElementById("mensaje").innerHTML = `<p style='color:red;'>❌ Error: ${result.detail || result.mensaje}</p>`;
                }
            } catch (err) {
                document.getElementById("mensaje").innerHTML = `<p style='color:red;'>⚠️ Error de conexión: ${err.customMessage}</p>`;
            }
        });
        </script>
        <!-- CSS externo aplicado -->
    </div>
</body>
</html>

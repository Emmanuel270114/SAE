{% extends 'base.html' %}

{% block title %}Captura de Matr√≠cula (SP){% endblock %}

{% block styles %}
    <link rel="stylesheet" href="/static/css/components/header.css">
    <link rel="stylesheet" href="/static/css/components/tables.css">
    <link rel="stylesheet" href="/static/css/components/matricula_consulta.css">
    <style>
        /* Ocultar el submenu de categorias que viene de base.html en esta vista */
        .submenu-categorias-box { display: none !important; }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header-usuarios">
        <div class="bienvenido">Bienvenido: <strong>{{ nombre_usuario }}</strong>
            {% if periodo_default_id %}
                &nbsp;|&nbsp; Periodo: <strong>{% for p in periodos %}{% if p.Id_Periodo == periodo_default_id %}{{ p.Periodo }}{% endif %}{% endfor %}</strong>
            {% endif %}
            {% if unidad_actual %}
                &nbsp;|&nbsp; Unidad Acad√©mica: <strong>{{ unidad_actual.Nombre }}</strong>
            {% endif %}
        </div>
        <form action="/mod_principal" method="get">
            <button type="submit" class="btn-volver">Regresar</button>
        </form>
    </div>

    <h2>Captura de Matr√≠cula Escolar (Stored Procedure)</h2>

    {% if not programas %}
    <div class="alert-info">
        <strong>Informaci√≥n:</strong> No hay programas disponibles para su nivel y unidad acad√©mica.
    </div>
    {% else %}

    <!-- Secci√≥n de Filtros con dise√±o horizontal -->
    <div class="filtros-container">
        <div class="filtros-row">
            <!-- Periodo removido de los filtros: usamos el periodo por defecto en el header -->
            <input type="hidden" id="periodo" name="periodo" value="{{ periodo_default_id }}">
            
            <div class="filtro-item">
                <label for="programa">Programa Acad√©mico:</label>
                <select id="programa" name="programa" required>
                    {% for programa in programas %}
                    <option value="{{ programa.Id_Programa }}" data-max-semestre="{{ programa.Id_Semestre }}">{{ programa.Nombre_Programa }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filtro-item">
                <label for="semestre">Semestre:</label>
                <select id="semestre" name="semestre" required>
                    {% for semestre in semestres %}
                    <option value="{{ semestre.Id_Semestre }}">{{ semestre.Semestre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filtro-item">
                <label for="modalidad">Modalidad:</label>
                <select id="modalidad" name="modalidad" required>
                    {% for modalidad in modalidades %}
                    <option value="{{ modalidad.Id_Modalidad }}">{{ modalidad.Modalidad }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filtro-item">
                <label for="turno">Turno:</label>
                <select id="turno" name="turno" required>
                    {% for turno in turnos %}
                    <option value="{{ turno.Id_Turno }}">{{ turno.Turno }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Unidad Acad√©mica removida de los filtros: mostramos la UA en el header y la enviamos como hidden -->
            {% if unidad_actual %}
                <input type="hidden" id="unidad_academica" name="unidad_academica" value="{{ unidad_actual.Id_Unidad_Academica }}">
            {% else %}
                <input type="hidden" id="unidad_academica" name="unidad_academica" value="0">
            {% endif %}
        </div>
        
        <div class="periodo-info">
            <strong>Periodo:</strong> 
            {% for p in periodos %}
                {% if p.Id_Periodo == periodo_default_id %}{{ p.Periodo }}{% endif %}
            {% endfor %}
            &nbsp;|&nbsp;
            <strong>UA:</strong> {{ unidad_actual.Nombre if unidad_actual else 'No definida' }}
        </div>
    </div>

    <!-- Secci√≥n de Captura con tabla completa -->
    <div class="captura-container">
        <div class="tabla-matricula-container">
            <div class="tabla-header">
                <h3>Captura de Matr√≠cula Escolar</h3>
            </div>
            
            <table class="tabla-matricula-completa" style="box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <th class="col-tipo" style="padding: 15px; text-align: center; font-weight: 600; font-size: 14px;">Tipo de Ingreso</th>
                        <th class="col-edad" style="padding: 15px; text-align: center; font-weight: 600; font-size: 14px;">Edad</th>
                        <th class="col-sexos" style="padding: 15px; text-align: center; font-weight: 600; font-size: 14px;">Sexos</th>
                        <th class="col-inputs" style="padding: 15px; text-align: center; font-weight: 600; font-size: 14px;">Matr√≠cula (Ingresar Datos)</th>
                    </tr>
                </thead>
                <tbody id="matricula-tbody">
                    <tr><td colspan="4">Cargando datos...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="actions-section">
        <button type="button" class="btn-primary" onclick="guardarMatricula()">
            üíæ Guardar Matr√≠cula
        </button>
        <button type="button" class="btn-secondary" onclick="limpiarFormulario()">
            üßπ Limpiar Formulario
        </button>
        <button type="button" class="btn-secondary" onclick="window.location.href='/mod_principal'">
            ‚Ü©Ô∏è Volver al Men√∫
        </button>
    </div>
    {% endif %}
</div>

{% block scripts %}
<script>
    // Funci√≥n para cargar datos existentes cuando cambien los filtros usando SP
    async function cargarDatosExistentes() {
        const periodo = document.getElementById('periodo').value;
        const programa = document.getElementById('programa').value;
        const modalidad = document.getElementById('modalidad').value;
        const semestre = document.getElementById('semestre').value;
        const turno = document.getElementById('turno').value;
        
        if (!periodo || !programa || !modalidad || !semestre || !turno) {
            return; // No cargar si faltan datos
        }
        
        try {
            const response = await fetch('/matricula/obtener_datos_existentes_sp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    periodo: periodo,
                    programa: programa,
                    modalidad: modalidad,
                    semestre: semestre,
                    turno: turno
                })
            });
            
            const resultado = await response.json();
            
            if (resultado.error) {
                console.error('Error al cargar datos existentes:', resultado.error);
                return;
            }
            
            // Si el backend devolvi√≥ rows (raw) preferimos reconstruir la tabla desde ellas
            if (resultado.rows && resultado.rows.length) {
                renderMatriculaFromSP(resultado.rows, resultado.datos || {});
            } else {
                // Limpiar formulario primero
                const inputs = document.querySelectorAll('input.input-matricula:not([readonly])');
                inputs.forEach(input => input.value = '0');
                
                // Cargar datos existentes por input individual
                const datos = resultado.datos || {};
                inputs.forEach(input => {
                    const tipoIngreso = input.getAttribute('data-tipo-ingreso');
                    const grupoEdad = input.getAttribute('data-grupo-edad');
                    const sexo = input.getAttribute('data-sexo');
                    
                    const key = `${tipoIngreso}_${grupoEdad}_${sexo}`;
                    if (datos[key]) {
                        input.value = datos[key];
                    }
                });
                
                // Recalcular totales
                calcularTotales();
            }
            
        } catch (error) {
            console.error('Error al cargar datos existentes:', error);
        }
    }

    // Renderiza la tabla de captura a partir de rows devueltas por el SP.
    // rows: array de objetos; datosMap: mapa opcional para poblar valores
    function renderMatriculaFromSP(rows, datosMap) {
        const tbody = document.getElementById('matricula-tbody');
        tbody.innerHTML = '';

        // Heur√≠sticas para columnas posibles
        const tipoCandidates = ['Id_Tipo_Ingreso','Id_TipoIngreso','Tipo_Id','Tipo_de_Ingreso','TipoIngreso','Tipo_Ingreso','Tipo'];
        const grupoCandidates = ['Id_Grupo_Edad','Id_GrupoEdad','IdGrupoEdad','Grupo_Edad','GrupoEdad','Grupo'];
        const sexoCandidates = ['Id_Sexo','IdSexo','Sexo','Genero','Nombre_Sexo'];
        const matriculaCandidates = ['Matricula','Total','Cantidad','Numero','Valor'];

        // Determinar columnas presentes
        const first = rows[0] || {};
        const keys = Object.keys(first);

        function findKey(cands) {
            for (let c of cands) if (keys.includes(c)) return c;
            // case-insensitive
            const low = keys.reduce((acc,k)=>{acc[k.toLowerCase()]=k;return acc;},{})
            for (let c of cands) if (low[c.toLowerCase()]) return low[c.toLowerCase()];
            return null;
        }

        const tipoKey = findKey(tipoCandidates);
        const grupoKey = findKey(grupoCandidates);
        const sexoKey = findKey(sexoCandidates);
        const matriculaKey = findKey(matriculaCandidates);

        // Construir rows agrupando por tipo+grupo y recolectar
        const combos = {};
        rows.forEach(r => {
            const tipoVal = tipoKey ? r[tipoKey] : (r['Tipo_de_Ingreso'] || r['Tipo'] || r['TipoIngreso'] || null);
            const grupoVal = grupoKey ? r[grupoKey] : (r['Grupo_Edad'] || r['Grupo'] || r['GrupoEdad'] || null);
            const sexoVal = sexoKey ? r[sexoKey] : (r['Sexo'] || r['Genero'] || null);
            const matriculaVal = matriculaKey ? r[matriculaKey] : (r['Matricula'] || r['Total'] || 0);

            const tipoId = tipoVal;
            const grupoId = grupoVal;
            const sexo = (sexoVal && String(sexoVal).toLowerCase().startsWith('m')) ? 'M' : 'F';

            const comboKey = `${tipoId}__${grupoId}`;
            combos[comboKey] = combos[comboKey] || { tipoId, grupoId, tipoLabel: tipoVal, grupoLabel: grupoVal, M: 0, F: 0 };
            const v = parseInt(matriculaVal) || 0;
            if (sexo === 'M') combos[comboKey].M += v; else combos[comboKey].F += v;
        });

        // Agrupar combos por tipoLabel (Nuevo Ingreso, Reingreso, Repetidores u otros)
        const groups = {};
        Object.values(combos).forEach(c => {
            const tipoNorm = String(c.tipoLabel || '').toLowerCase();
            let bucket = 'Otros';
            if (tipoNorm.includes('nuevo')) bucket = 'Nuevo Ingreso';
            else if (tipoNorm.includes('reingreso') || tipoNorm.includes('re-ingreso') || tipoNorm.includes('reingreso')) bucket = 'Reingreso';
            else if (tipoNorm.includes('repet') || tipoNorm.includes('repetidor')) bucket = 'Repetidores';
            groups[bucket] = groups[bucket] || [];
            groups[bucket].push(c);
        });

        // Ordenar cada grupo por total (M+F) descendente
        Object.keys(groups).forEach(k => {
            groups[k].sort((a,b) => (b.M + b.F) - (a.M + a.F));
        });

        // Order of display
        const displayOrder = ['Nuevo Ingreso','Reingreso','Repetidores','Otros'];

        // Renderizar grupos con separators
        displayOrder.forEach(groupName => {
            if (!groups[groupName] || !groups[groupName].length) return;
            // Separator row with improved styling
            const sep = document.createElement('tr');
            sep.innerHTML = `<td colspan="4" style="background: linear-gradient(135deg, #f1f3f4 0%, #e8eaf6 100%); padding: 12px 20px; font-weight: 700; font-size: 15px; color: #424242; border-top: 2px solid #5c6bc0; border-bottom: 1px solid #e0e0e0; text-transform: uppercase; letter-spacing: 0.5px;">üìä ${groupName}</td>`;
            tbody.appendChild(sep);

            groups[groupName].forEach(c => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f0f0f0';
                tr.style.transition = 'all 0.2s ease';
                tr.onmouseover = () => tr.style.backgroundColor = '#fafafa';
                tr.onmouseout = () => tr.style.backgroundColor = '';
                
                const tdTipo = document.createElement('td'); 
                tdTipo.innerHTML = `<strong style="color:#424242;font-size:14px;">${c.tipoLabel || ''}</strong>`;
                tdTipo.style.padding = '12px';
                tdTipo.style.verticalAlign = 'middle';
                
                const tdEdad = document.createElement('td'); 
                tdEdad.textContent = c.grupoLabel || '';
                tdEdad.style.padding = '12px';
                tdEdad.style.textAlign = 'center';
                tdEdad.style.fontWeight = '500';
                tdEdad.style.color = '#666';
                tdEdad.style.verticalAlign = 'middle';
                
                const tdSexos = document.createElement('td');
                tdSexos.style.padding = '12px';
                tdSexos.style.verticalAlign = 'middle'; 
                tdSexos.innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <div style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3;">
                            <div style="font-weight:600;color:#1976d2;">M</div>
                            <div style="font-size:13px;color:#1976d2;">Masculino</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:#fce4ec;border-radius:8px;border-left:4px solid #e91e63;">
                            <div style="font-weight:600;color:#c2185b;">F</div>
                            <div style="font-size:13px;color:#c2185b;">Femenino</div>
                        </div>
                    </div>`;
                
                const tdInputs = document.createElement('td');
                tdInputs.style.padding = '12px';
                tdInputs.style.verticalAlign = 'middle';

                // Inputs: dos filas dentro de la celda, cada una con su box con colores distintivos
                tdInputs.innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:#e3f2fd;border-radius:8px;border:1px solid #bbdefb;">
                            <div style="min-width:28px;text-align:center;font-weight:700;color:#1976d2;font-size:16px;">M</div>
                            <div style="flex:1;">
                                <input type="number" 
                                       id="input_${c.tipoId}_${c.grupoId}_M" 
                                       value="${c.M || 0}" 
                                       min="0" 
                                       class="input-matricula" 
                                       data-tipo-ingreso="${c.tipoId}" 
                                       data-grupo-edad="${c.grupoId}" 
                                       data-sexo="M" 
                                       style="width:100px;padding:8px 12px;border:2px solid #2196f3;border-radius:6px;background:#fff;color:#1976d2;font-weight:600;text-align:center;" 
                                       placeholder="0"
                                       onchange="this.style.borderColor = this.value > 0 ? '#4caf50' : '#2196f3';">
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:#fce4ec;border-radius:8px;border:1px solid #f8bbd9;">
                            <div style="min-width:28px;text-align:center;font-weight:700;color:#c2185b;font-size:16px;">F</div>
                            <div style="flex:1;">
                                <input type="number" 
                                       id="input_${c.tipoId}_${c.grupoId}_F" 
                                       value="${c.F || 0}" 
                                       min="0" 
                                       class="input-matricula" 
                                       data-tipo-ingreso="${c.tipoId}" 
                                       data-grupo-edad="${c.grupoId}" 
                                       data-sexo="F" 
                                       style="width:100px;padding:8px 12px;border:2px solid #e91e63;border-radius:6px;background:#fff;color:#c2185b;font-weight:600;text-align:center;" 
                                       placeholder="0"
                                       onchange="this.style.borderColor = this.value > 0 ? '#4caf50' : '#e91e63';">
                            </div>
                        </div>
                    </div>`;

                tr.appendChild(tdTipo);
                tr.appendChild(tdEdad);
                tr.appendChild(tdSexos);
                tr.appendChild(tdInputs);
                tbody.appendChild(tr);
            });
        });

        // Agregar fila de totales con dise√±o mejorado
        const trTot = document.createElement('tr');
        trTot.className = 'totales-row';
        trTot.style.borderTop = '3px solid #ddd';
        trTot.style.backgroundColor = '#f8f9fa';
        trTot.innerHTML = `
            <td class="totales-label" style="padding:12px;"><strong style="font-size:16px;">TOTALES</strong></td>
            <td></td>
            <td></td>
            <td class="total-cell" style="padding:12px;">
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:#e3f2fd;border-radius:8px;border:1px solid #bbdefb;">
                        <div style="min-width:28px;text-align:center;font-weight:700;color:#1976d2;font-size:16px;">M</div>
                        <div style="flex:1;display:flex;justify-content:center;">
                            <span id="total_masculino" style="font-weight:700;color:#1976d2;font-size:18px;background:#fff;padding:6px 16px;border-radius:6px;border:2px solid #2196f3;min-width:60px;text-align:center;">0</span>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:#fce4ec;border-radius:8px;border:1px solid #f8bbd9;">
                        <div style="min-width:28px;text-align:center;font-weight:700;color:#c2185b;font-size:16px;">F</div>
                        <div style="flex:1;display:flex;justify-content:center;">
                            <span id="total_femenino" style="font-weight:700;color:#c2185b;font-size:18px;background:#fff;padding:6px 16px;border-radius:6px;border:2px solid #e91e63;min-width:60px;text-align:center;">0</span>
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:8px;padding:8px;background:#e8f5e8;border-radius:8px;border:2px solid #4caf50;">
                        <strong style="color:#2e7d32;font-size:16px;">TOTAL GENERAL: <span id="total_general" style="font-size:20px;">0</span></strong>
                    </div>
                </div>
            </td>`;
        tbody.appendChild(trTot);

        // Re-bind events for inputs
        const inputs = document.querySelectorAll('input.input-matricula');
        inputs.forEach(input => {
            input.addEventListener('input', calcularTotales);
            input.addEventListener('change', calcularTotales);
        });

        // Si se pas√≥ un datosMap, poblar valores
        if (datosMap) {
            for (let key in datosMap) {
                const val = datosMap[key];
                // formato esperado: tipo_grupo_sexo
                const parts = key.split('_');
                if (parts.length === 3) {
                    const idTipo = parts[0], idGrupo = parts[1], sexo = parts[2];
                    const el = document.getElementById(`input_${idTipo}_${idGrupo}_${sexo}`);
                    if (el) el.value = val;
                }
            }
        }

        calcularTotales();
    }

    function calcularTotales() {
        // Calcular totales por sexo y total general
        let totalMasculino = 0;
        let totalFemenino = 0;
        let totalGeneral = 0;
        
        const inputs = document.querySelectorAll('input.input-matricula');
        
        inputs.forEach(input => {
            const valor = parseInt(input.value) || 0;
            const sexo = input.getAttribute('data-sexo');
            
            totalGeneral += valor;
            
            if (sexo === 'M') {
                totalMasculino += valor;
            } else if (sexo === 'F') {
                totalFemenino += valor;
            }
        });
        
        // Actualizar los spans de totales
        const totalMasculinoEl = document.querySelector('#total_masculino');
        const totalFemeninoEl = document.querySelector('#total_femenino');
        const totalGeneralEl = document.querySelector('#total_general');
        
        if (totalMasculinoEl) totalMasculinoEl.textContent = totalMasculino;
        if (totalFemeninoEl) totalFemeninoEl.textContent = totalFemenino;
        if (totalGeneralEl) totalGeneralEl.textContent = totalGeneral;
    }

    function guardarMatricula() {
        // Validar que al menos un campo tenga datos
        const inputs = document.querySelectorAll('input.input-matricula');
        let hasData = false;
        
        for (let input of inputs) {
            if (parseInt(input.value) > 0) {
                hasData = true;
                break;
            }
        }
        
        if (!hasData) {
            alert('‚ö†Ô∏è Por favor, ingrese al menos un valor mayor a 0 antes de guardar.');
            return;
        }

        // Validar que los filtros est√©n seleccionados
        const periodo = document.getElementById('periodo').value;
        const programa = document.getElementById('programa').value;
        const semestre = document.getElementById('semestre').value;
        const modalidad = document.getElementById('modalidad').value;
        const turno = document.getElementById('turno').value;
        
        if (!periodo || !programa || !semestre || !modalidad || !turno) {
            alert('‚ö†Ô∏è Por favor, complete todos los filtros antes de guardar.');
            return;
        }

        // Recopilar todos los datos del formulario
        const data = {
            periodo: periodo,
            programa: programa,
            semestre: semestre,
            modalidad: modalidad,
            turno: turno,
            datos_matricula: {}
        };

        // Obtener datos de cada input
        inputs.forEach(input => {
            const tipoIngreso = input.getAttribute('data-tipo-ingreso');
            const grupoEdad = input.getAttribute('data-grupo-edad');
            const sexo = input.getAttribute('data-sexo');
            const valor = parseInt(input.value) || 0;
            
            if (valor > 0) {
                const key = `${tipoIngreso}_${grupoEdad}_${sexo}`;
                data.datos_matricula[key] = {
                    tipo_ingreso: tipoIngreso,
                    grupo_edad: grupoEdad,
                    sexo: sexo,
                    matricula: valor
                };
            }
        });

        // Mostrar indicador de carga
        const saveBtn = document.querySelector('.btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '‚è≥ Guardando...';
        saveBtn.disabled = true;

        // Enviar datos al backend
        fetch('/matricula/guardar_captura_completa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.mensaje) {
                alert('‚úÖ ' + data.mensaje);
                limpiarFormulario();
            } else {
                alert('‚ùå Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al procesar la solicitud. Por favor, intente nuevamente.');
        })
        .finally(() => {
            // Restaurar bot√≥n
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        });
    }

    function limpiarFormulario() {
        const inputs = document.querySelectorAll('input.input-matricula');
        inputs.forEach(input => input.value = '0');
        calcularTotales(); // Recalcular totales despu√©s de limpiar
    }

    // Agregar eventos a los inputs para c√°lculos autom√°ticos
    document.addEventListener('DOMContentLoaded', function() {
        // Obtener mapeo de semestres desde backend y luego reconstruir select
        window._semestres_map = {};
        async function fetchSemestresMap() {
            try {
                const resp = await fetch('/matricula/semestres_map');
                const json = await resp.json();
                if (!json || json.error) {
                    console.warn('No se pudo obtener semestres_map:', json && json.error);
                    return;
                }
                window._semestres_map = json;
                // Despu√©s de obtener el map, reconstruir semestres y actualizar el select
                rebuildSemestres();
            } catch (err) {
                console.error('Error al obtener semestres_map:', err);
            }
        }
        
        // Funci√≥n para reconstruir select de semestres seg√∫n programa
        function rebuildSemestres() {
            const programaSel = document.getElementById('programa');
            const semestreSel = document.getElementById('semestre');
            if (!programaSel || !semestreSel) return;
            const opt = programaSel.selectedOptions[0];
            const maxSem = parseInt(opt?.getAttribute('data-max-semestre')) || 1;
            // Limpiar
            semestreSel.innerHTML = '';
            // Construir lista de semestres tomando los primeros maxSem ordenados por Id
            const semIds = Object.keys(window._semestres_map).map(x => parseInt(x)).sort((a,b)=>a-b);
            for (let i = 0; i < Math.min(maxSem, semIds.length); i++) {
                const semId = semIds[i];
                const o = document.createElement('option');
                o.value = semId; // usar Id_Semestre real
                o.textContent = window._semestres_map[String(semId)] || String(semId);
                semestreSel.appendChild(o);
            }
        }
        
        // Ejecutar al cambiar programa
        const programaEl = document.getElementById('programa');
        if (programaEl) {
            programaEl.addEventListener('change', rebuildSemestres);
        }
        
        const inputs = document.querySelectorAll('input.input-matricula');
        inputs.forEach(input => {
            input.addEventListener('input', calcularTotales);
            input.addEventListener('change', calcularTotales);
        });
        
        // Agregar eventos a los filtros para cargar datos existentes
        const filtros = ['periodo', 'programa', 'modalidad', 'semestre', 'turno'];
        filtros.forEach(filtroId => {
            const elemento = document.getElementById(filtroId);
            if (elemento) {
                elemento.addEventListener('change', cargarDatosExistentes);
            }
        });

    // Obtener mapping de semestres y luego reconstruir semestres con el programa por defecto
    fetchSemestresMap();

    // Cargar datos existentes desde el SP para poblar la vista al inicio
    cargarDatosExistentes();
        
        // Calcular totales iniciales
        calcularTotales();
    });
</script>
<!-- Panel debug opcional para ver filas crudas del SP -->
<div id="sp-debug-panel" style="margin:20px; padding:10px; border:1px solid #ddd; display:none;">
    <h4>Debug SP - Filas crudas</h4>
    <div id="sp-debug-content">(vacio)</div>
</div>
<script>
    // Funci√≥n para renderizar rows devueltas por el backend (para debug)
    function renderSPRows(rows) {
        const panel = document.getElementById('sp-debug-panel');
        const content = document.getElementById('sp-debug-content');
        if (!rows || !rows.length) {
            panel.style.display = 'none';
            return;
        }
        panel.style.display = 'block';
        // Construir tabla HTML
        const cols = Object.keys(rows[0]);
        let html = '<table style="width:100%; border-collapse:collapse;">';
        html += '<thead><tr>' + cols.map(c => `<th style="border:1px solid #ccc;padding:6px;background:#f5f5f5;">${c}</th>`).join('') + '</tr></thead>';
        html += '<tbody>';
        rows.forEach(r => {
            html += '<tr>' + cols.map(c => `<td style="border:1px solid #eee;padding:6px;">${(r[c] === null || r[c] === undefined) ? '' : r[c]}</td>`).join('') + '</tr>';
        });
        html += '</tbody></table>';
        content.innerHTML = html;
    }
</script>
{% endblock %}

{% endblock %}

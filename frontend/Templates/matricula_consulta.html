{% extends 'base.html' %}

{% block title %}Captura de Matr√≠cula (SP){% endblock %}

{% block styles %}
    <link rel="stylesheet" href="/static/css/components/header.css">
    <link rel="stylesheet" href="/static/css/components/tables.css">
    <link rel="stylesheet" href="/static/css/components/matricula_consulta.css">
    <style>
        /* Ocultar el submenu de categorias que viene de base.html en esta vista */
        .submenu-categorias-box { display: none !important; }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header-usuarios">
        <div class="bienvenido">Bienvenido: <strong>{{ nombre_usuario }}</strong>
            {% if periodo_default_id %}
                &nbsp;|&nbsp; Periodo: <strong> 2025-2026/1 </strong>
            {% endif %}
            {% if unidad_actual %}
                &nbsp;|&nbsp; Unidad Acad√©mica: <strong>{{ unidad_actual.Nombre }}</strong>
            {% endif %}
        </div>
        <form action="/mod_principal" method="get">
            <button type="submit" class="btn-volver">Regresar</button>
        </form>
    </div>

    <h2>Captura de Matr√≠cula Escolar</h2>

    {% if not programas %}
    <div class="alert-info">
        <strong>Informaci√≥n:</strong> No hay programas disponibles para su nivel y unidad acad√©mica.
    </div>
    {% else %}

    <!-- Secci√≥n de Filtros con dise√±o horizontal -->
    <div class="filtros-container">
        <div class="filtros-row">
            <!-- Periodo removido de los filtros: usamos el periodo por defecto en el header -->
            <input type="hidden" id="periodo" name="periodo" value="{{ periodo_default_id }}">
            
            <div class="filtro-item">
                <label for="programa"> <strong>Programa Acad√©mico:</strong></label>
                <select id="programa" name="programa" required>
                    {% for programa in programas %}
                    <option value="{{ programa.Id_Programa }}" data-max-semestre="{{ programa.Id_Semestre }}">{{ programa.Nombre_Programa }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filtro-item">
                <label for="modalidad"> <strong>Modalidad:</strong></label>
                <select id="modalidad" name="modalidad" required>
                    {% for modalidad in modalidades %}
                    <option value="{{ modalidad.Id_Modalidad }}">{{ modalidad.Modalidad }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Campos ocultos para semestre y turno (se manejan con pesta√±as y botones) -->
            <input type="hidden" id="semestre" name="semestre" value="1">
            <input type="hidden" id="turno" name="turno" value="1">

            <!-- Unidad Acad√©mica removida de los filtros: mostramos la UA en el header y la enviamos como hidden -->
            {% if unidad_actual %}
                <input type="hidden" id="unidad_academica" name="unidad_academica" value="{{ unidad_actual.Id_Unidad_Academica }}">
            {% else %}
                <input type="hidden" id="unidad_academica" name="unidad_academica" value="0">
            {% endif %}
        </div>
        
        <div class="periodo-info">
            Periodo:
            <strong>2025-2026/1</strong>
            &nbsp;|&nbsp;
            Unidad Acad√©mica: <strong>{{ unidad_actual.Nombre if unidad_actual else 'No definida' }}</strong>
        </div>
    </div>

    <!-- Secci√≥n de Captura con tabla completa -->
    <div class="captura-container">
        <!-- Pesta√±as de Semestres -->
        <div class="semestres-tabs" id="semestres-tabs">
            <!-- Las pesta√±as se generar√°n din√°micamente con JavaScript -->
        </div>

        <!-- Navegaci√≥n de Turnos -->
        <div class="turno-navigation">
            <div class="turno-display">
                <span class="turno-label">Turno:</span>
                <span class="turno-nombre" id="turno-nombre">Matutino</span>
            </div>
            <div class="turno-buttons">
                <button type="button" class="btn-turno" id="btn-turno-anterior" onclick="cambiarTurno(-1)">
                    ‚Üê Anterior
                </button>
                <button type="button" class="btn-turno" id="btn-turno-siguiente" onclick="cambiarTurno(1)">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <div class="tabla-matricula-container">
            
            <table class="tabla-matricula-completa" style="box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <th class="col-edad" style="padding: 15px; text-align: center; font-weight: 600; font-size: 14px; width: 15%;">Edad</th>
                        <th class="col-tipo-ingreso" style="padding: 15px; text-align: center; font-weight: 600; font-size: 14px; width: 28%;">Nuevo Ingreso</th>
                        <th class="col-tipo-ingreso" style="padding: 15px; text-align: center; font-weight: 600; font-size: 14px; width: 28%;">Reingreso</th>
                        <th class="col-tipo-ingreso" style="padding: 15px; text-align: center; font-weight: 600; font-size: 14px; width: 28%;">Repetidores</th>
                    </tr>
                </thead>
                <tbody id="matricula-tbody">
                    <tr><td colspan="4">Cargando datos...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="actions-section">
        <button type="button" class="btn-primary" onclick="guardarMatricula()">
            üíæ Guardar Matr√≠cula
        </button>
        <button type="button" class="btn-secondary" onclick="limpiarFormulario()">
            üßπ Limpiar Formulario
        </button>
        <button type="button" class="btn-secondary" onclick="window.location.href='/mod_principal'">
            ‚Ü©Ô∏è Volver al Men√∫
        </button>
    </div>
    {% endif %}
</div>

{% block scripts %}
<script>
    // Funci√≥n para cargar datos existentes cuando cambien los filtros usando SP
    async function cargarDatosExistentes() {
        const periodo = document.getElementById('periodo').value;
        const programa = document.getElementById('programa').value;
        const modalidad = document.getElementById('modalidad').value;
        const semestre = document.getElementById('semestre').value;
        const turno = document.getElementById('turno').value;
        
        console.log('=== cargarDatosExistentes ===');
        console.log('Periodo:', periodo);
        console.log('Programa:', programa);
        console.log('Modalidad:', modalidad);
        console.log('Semestre:', semestre);
        console.log('Turno:', turno);
        
        if (!periodo || !programa || !modalidad || !semestre || !turno) {
            console.log('Faltan datos en los filtros, generando tabla vac√≠a');
            generarTablaVacia();
            return;
        }
        
        try {
            const response = await fetch('/matricula/obtener_datos_existentes_sp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    periodo: periodo,
                    programa: programa,
                    modalidad: modalidad,
                    semestre: semestre,
                    turno: turno
                })
            });
            
            const resultado = await response.json();
            console.log('Resultado del backend:', resultado);
            
            if (resultado.error) {
                console.error('Error al cargar datos existentes:', resultado.error);
                generarTablaVacia();
                return;
            }
            
            // Si el backend devolvi√≥ rows (raw) preferimos reconstruir la tabla desde ellas
            if (resultado.rows && resultado.rows.length > 0) {
                console.log('‚úÖ Renderizando desde SP con rows:', resultado.rows.length);
                console.log('Primera fila:', resultado.rows[0]);
                renderMatriculaFromSP(resultado.rows, resultado.datos || {});
            } else {
                console.log('‚ö†Ô∏è No hay rows del SP, generando tabla por defecto');
                // Si no hay datos del SP, generar estructura por defecto
                generarTablaVacia();
            }
            
        } catch (error) {
            console.error('‚ùå Error al cargar datos existentes:', error);
            generarTablaVacia();
        }
    }

    // Renderiza la tabla de captura a partir de rows devueltas por el SP con nueva estructura
    // rows: array de objetos; datosMap: mapa opcional para poblar valores
    function renderMatriculaFromSP(rows, datosMap) {
        console.log('=== renderMatriculaFromSP ===');
        console.log('N√∫mero de rows:', rows.length);
        console.log('datosMap:', datosMap);
        
        const tbody = document.getElementById('matricula-tbody');
        tbody.innerHTML = '';

        if (!rows || rows.length === 0) {
            console.log('‚ö†Ô∏è No hay rows para renderizar, generando tabla vac√≠a');
            generarTablaVacia();
            return;
        }

        // Heur√≠sticas para columnas posibles
        const tipoCandidates = ['Id_Tipo_Ingreso','Id_TipoIngreso','Tipo_Id','Tipo_de_Ingreso','TipoIngreso','Tipo_Ingreso','Tipo'];
        const grupoCandidates = ['Id_Grupo_Edad','Id_GrupoEdad','IdGrupoEdad','Grupo_Edad','GrupoEdad','Grupo'];
        const sexoCandidates = ['Id_Sexo','IdSexo','Sexo','Genero','Nombre_Sexo'];
        const matriculaCandidates = ['Matricula','Total','Cantidad','Numero','Valor'];
        
        console.log('Columnas disponibles en la primera fila:', Object.keys(rows[0]));

        // Determinar columnas presentes
        const first = rows[0] || {};
        const keys = Object.keys(first);

        function findKey(cands) {
            for (let c of cands) if (keys.includes(c)) return c;
            const low = keys.reduce((acc,k)=>{acc[k.toLowerCase()]=k;return acc;},{})
            for (let c of cands) if (low[c.toLowerCase()]) return low[c.toLowerCase()];
            return null;
        }

        const tipoKey = findKey(tipoCandidates);
        const grupoKey = findKey(grupoCandidates);
        const sexoKey = findKey(sexoCandidates);
        const matriculaKey = findKey(matriculaCandidates);

        // Construir estructura: agrupar por edad y tipo de ingreso
        const edadMap = {};
        
        rows.forEach(r => {
            const tipoVal = tipoKey ? r[tipoKey] : (r['Tipo_de_Ingreso'] || r['Tipo'] || r['TipoIngreso'] || null);
            const grupoVal = grupoKey ? r[grupoKey] : (r['Grupo_Edad'] || r['Grupo'] || r['GrupoEdad'] || null);
            const sexoVal = sexoKey ? r[sexoKey] : (r['Sexo'] || r['Genero'] || null);
            const matriculaVal = matriculaKey ? r[matriculaKey] : (r['Matricula'] || r['Total'] || 0);

            const tipoId = tipoVal;
            const grupoId = grupoVal;
            const grupoLabel = grupoVal;
            const sexo = (sexoVal && String(sexoVal).toLowerCase().startsWith('m')) ? 'M' : 'F';
            
            // Normalizar tipo de ingreso
            const tipoNorm = String(tipoVal || '').toLowerCase();
            let tipoCategoria = 'Otros';
            if (tipoNorm.includes('nuevo')) tipoCategoria = 'Nuevo Ingreso';
            else if (tipoNorm.includes('reingreso') || tipoNorm.includes('re-ingreso')) tipoCategoria = 'Reingreso';
            else if (tipoNorm.includes('repet') || tipoNorm.includes('repetidor')) tipoCategoria = 'Repetidores';

            if (!edadMap[grupoId]) {
                edadMap[grupoId] = {
                    grupoLabel: grupoLabel,
                    'Nuevo Ingreso': { tipoId: null, M: 0, F: 0 },
                    'Reingreso': { tipoId: null, M: 0, F: 0 },
                    'Repetidores': { tipoId: null, M: 0, F: 0 }
                };
            }
            
            if (!edadMap[grupoId][tipoCategoria].tipoId) {
                edadMap[grupoId][tipoCategoria].tipoId = tipoId;
            }
            
            const v = parseInt(matriculaVal) || 0;
            if (sexo === 'M') edadMap[grupoId][tipoCategoria].M += v;
            else edadMap[grupoId][tipoCategoria].F += v;
        });

        // Ordenar edades (asumiendo que son n√∫meros o pueden ordenarse)
        const edadesOrdenadas = Object.keys(edadMap).sort((a, b) => {
            const numA = parseInt(a) || 0;
            const numB = parseInt(b) || 0;
            return numA - numB;
        });

        console.log('Edades encontradas:', edadesOrdenadas);
        console.log('edadMap completo:', edadMap);

        if (edadesOrdenadas.length === 0) {
            console.log('‚ö†Ô∏è No se encontraron edades en los datos del SP');
            generarTablaVacia();
            return;
        }

        // Renderizar filas por edad
        edadesOrdenadas.forEach(grupoId => {
            const edadData = edadMap[grupoId];
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #e0e0e0';
            tr.style.transition = 'all 0.2s ease';
            tr.onmouseover = () => tr.style.backgroundColor = '#f5f5f5';
            tr.onmouseout = () => tr.style.backgroundColor = '';

            // Columna de Edad
            const tdEdad = document.createElement('td');
            tdEdad.textContent = edadData.grupoLabel || grupoId;
            tdEdad.style.padding = '12px';
            tdEdad.style.textAlign = 'center';
            tdEdad.style.fontWeight = '700';
            tdEdad.style.fontSize = '15px';
            tdEdad.style.color = '#424242';
            tdEdad.style.background = '#f8f9fa';
            tdEdad.style.verticalAlign = 'middle';

            // Columnas para cada tipo de ingreso
            ['Nuevo Ingreso', 'Reingreso', 'Repetidores'].forEach(tipoCategoria => {
                const tdTipo = document.createElement('td');
                tdTipo.style.padding = '10px';
                tdTipo.style.verticalAlign = 'middle';
                
                const datos = edadData[tipoCategoria];
                const tipoId = datos.tipoId || tipoCategoria.replace(' ', '_');

                tdTipo.innerHTML = `
                    <div style="display:flex;gap:8px;justify-content:center;align-items:center;">
                        <div style="flex:1;max-width:110px;">
                            <div style="display:flex;align-items:center;gap:4px;padding:6px 8px;background:#e3f2fd;border-radius:6px;border:1px solid #90caf9;margin-bottom:6px;">
                                <div style="font-weight:700;color:#1976d2;font-size:14px;min-width:20px;">M</div>
                                <input type="number" 
                                       id="input_${tipoId}_${grupoId}_M" 
                                       value="${datos.M || 0}" 
                                       min="0" 
                                       class="input-matricula-nueva" 
                                       data-tipo-ingreso="${tipoId}" 
                                       data-grupo-edad="${grupoId}" 
                                       data-sexo="M" 
                                       style="width:100%;padding:6px 8px;border:2px solid #2196f3;border-radius:4px;background:#fff;color:#1976d2;font-weight:600;text-align:center;font-size:14px;" 
                                       placeholder="0">
                            </div>
                            <div style="display:flex;align-items:center;gap:4px;padding:6px 8px;background:#fce4ec;border-radius:6px;border:1px solid #f48fb1;">
                                <div style="font-weight:700;color:#c2185b;font-size:14px;min-width:20px;">F</div>
                                <input type="number" 
                                       id="input_${tipoId}_${grupoId}_F" 
                                       value="${datos.F || 0}" 
                                       min="0" 
                                       class="input-matricula-nueva" 
                                       data-tipo-ingreso="${tipoId}" 
                                       data-grupo-edad="${grupoId}" 
                                       data-sexo="F" 
                                       style="width:100%;padding:6px 8px;border:2px solid #e91e63;border-radius:4px;background:#fff;color:#c2185b;font-weight:600;text-align:center;font-size:14px;" 
                                       placeholder="0">
                            </div>
                        </div>
                    </div>`;

                tr.appendChild(tdEdad.cloneNode ? tdEdad.cloneNode(true) : tdEdad);
                tdEdad = null; // Solo agregar edad una vez
            });

            // Agregar celdas de tipos de ingreso
            ['Nuevo Ingreso', 'Reingreso', 'Repetidores'].forEach((tipoCategoria, idx) => {
                const tdTipo = document.createElement('td');
                tdTipo.style.padding = '10px';
                tdTipo.style.verticalAlign = 'middle';
                
                const datos = edadData[tipoCategoria];
                const tipoId = datos.tipoId || tipoCategoria.replace(' ', '_');

                tdTipo.innerHTML = `
                    <div style="display:flex;gap:8px;justify-content:center;align-items:center;">
                        <div style="flex:1;max-width:110px;">
                            <div style="display:flex;align-items:center;gap:4px;padding:6px 8px;background:#e3f2fd;border-radius:6px;border:1px solid #90caf9;margin-bottom:6px;">
                                <div style="font-weight:700;color:#1976d2;font-size:14px;min-width:20px;">M</div>
                                <input type="number" 
                                       id="input_${tipoId}_${grupoId}_M" 
                                       value="${datos.M || 0}" 
                                       min="0" 
                                       class="input-matricula-nueva" 
                                       data-tipo-ingreso="${tipoId}" 
                                       data-grupo-edad="${grupoId}" 
                                       data-sexo="M" 
                                       style="width:100%;padding:6px 8px;border:2px solid #2196f3;border-radius:4px;background:#fff;color:#1976d2;font-weight:600;text-align:center;font-size:14px;" 
                                       placeholder="0">
                            </div>
                            <div style="display:flex;align-items:center;gap:4px;padding:6px 8px;background:#fce4ec;border-radius:6px;border:1px solid #f48fb1;">
                                <div style="font-weight:700;color:#c2185b;font-size:14px;min-width:20px;">F</div>
                                <input type="number" 
                                       id="input_${tipoId}_${grupoId}_F" 
                                       value="${datos.F || 0}" 
                                       min="0" 
                                       class="input-matricula-nueva" 
                                       data-tipo-ingreso="${tipoId}" 
                                       data-grupo-edad="${grupoId}" 
                                       data-sexo="F" 
                                       style="width:100%;padding:6px 8px;border:2px solid #e91e63;border-radius:4px;background:#fff;color:#c2185b;font-weight:600;text-align:center;font-size:14px;" 
                                       placeholder="0">
                            </div>
                        </div>
                    </div>`;

                if (idx === 0) {
                    tr.appendChild(tdEdad);
                }
                tr.appendChild(tdTipo);
            });

            tbody.appendChild(tr);
        });

        // Agregar fila de totales
        const trTot = document.createElement('tr');
        trTot.className = 'totales-row';
        trTot.style.borderTop = '3px solid #8B2635';
        trTot.style.backgroundColor = '#f8f9fa';
        trTot.innerHTML = `
            <td style="padding:12px;text-align:center;font-weight:700;font-size:16px;background:#8B2635;color:white;">TOTALES</td>
            <td style="padding:12px;text-align:center;" colspan="3">
                <div style="display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap;gap:15px;">
                    <div style="flex:1;min-width:120px;">
                        <div style="background:#e3f2fd;padding:8px;border-radius:8px;border:2px solid #2196f3;">
                            <div style="font-size:13px;color:#1976d2;font-weight:600;margin-bottom:4px;">Masculino</div>
                            <div id="total_masculino" style="font-size:24px;color:#1976d2;font-weight:700;">0</div>
                        </div>
                    </div>
                    <div style="flex:1;min-width:120px;">
                        <div style="background:#fce4ec;padding:8px;border-radius:8px;border:2px solid #e91e63;">
                            <div style="font-size:13px;color:#c2185b;font-weight:600;margin-bottom:4px;">Femenino</div>
                            <div id="total_femenino" style="font-size:24px;color:#c2185b;font-weight:700;">0</div>
                        </div>
                    </div>
                    <div style="flex:1;min-width:140px;">
                        <div style="background:#e8f5e9;padding:8px;border-radius:8px;border:2px solid #4caf50;">
                            <div style="font-size:13px;color:#2e7d32;font-weight:600;margin-bottom:4px;">TOTAL GENERAL</div>
                            <div id="total_general" style="font-size:26px;color:#2e7d32;font-weight:700;">0</div>
                        </div>
                    </div>
                </div>
            </td>`;
        tbody.appendChild(trTot);

        // Re-bind events for inputs
        const inputs = document.querySelectorAll('input.input-matricula-nueva');
        inputs.forEach(input => {
            input.addEventListener('input', calcularTotales);
            input.addEventListener('change', calcularTotales);
        });

        // Si se pas√≥ un datosMap, poblar valores
        if (datosMap) {
            for (let key in datosMap) {
                const val = datosMap[key];
                const parts = key.split('_');
                if (parts.length === 3) {
                    const idTipo = parts[0], idGrupo = parts[1], sexo = parts[2];
                    const el = document.getElementById(`input_${idTipo}_${idGrupo}_${sexo}`);
                    if (el) el.value = val;
                }
            }
        }

        calcularTotales();
    }

    function calcularTotales() {
        // Calcular totales por sexo y total general
        let totalMasculino = 0;
        let totalFemenino = 0;
        let totalGeneral = 0;
        
        const inputs = document.querySelectorAll('input.input-matricula-nueva');
        
        inputs.forEach(input => {
            const valor = parseInt(input.value) || 0;
            const sexo = input.getAttribute('data-sexo');
            
            totalGeneral += valor;
            
            if (sexo === 'M') {
                totalMasculino += valor;
            } else if (sexo === 'F') {
                totalFemenino += valor;
            }
        });
        
        // Actualizar los spans de totales
        const totalMasculinoEl = document.querySelector('#total_masculino');
        const totalFemeninoEl = document.querySelector('#total_femenino');
        const totalGeneralEl = document.querySelector('#total_general');
        
        if (totalMasculinoEl) totalMasculinoEl.textContent = totalMasculino;
        if (totalFemeninoEl) totalFemeninoEl.textContent = totalFemenino;
        if (totalGeneralEl) totalGeneralEl.textContent = totalGeneral;
    }

    // Funci√≥n para generar tabla vac√≠a con estructura basada en grupos de edad del backend
    function generarTablaVacia() {
        const tbody = document.getElementById('matricula-tbody');
        tbody.innerHTML = '';
        
        // Usar grupos de edad del backend en lugar de valores predefinidos
        const gruposEdad = {{ grupos_edad | tojson }};
        console.log('Grupos de edad desde backend para tabla vac√≠a:', gruposEdad);
        
        // Si no hay grupos de edad del backend, usar valores por defecto
        let edadesParaUsar = [];
        if (gruposEdad && gruposEdad.length > 0) {
            edadesParaUsar = gruposEdad.map(g => ({
                id: g.Id_Grupo_Edad,
                label: g.Grupo_Edad
            }));
        } else {
            // Fallback: edades por defecto
            const edadesDefault = [
                '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', 'M√°s de 25'
            ];
            edadesParaUsar = edadesDefault.map((edad, idx) => ({
                id: idx + 1,
                label: edad
            }));
        }
        
        // Tipos de ingreso fijos
        const tiposIngreso = [
            { id: 1, nombre: 'Nuevo Ingreso' },
            { id: 2, nombre: 'Reingreso' },
            { id: 3, nombre: 'Repetidores' }
        ];
        
        edadesParaUsar.forEach((edadObj, idxEdad) => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #e0e0e0';
            tr.style.transition = 'all 0.2s ease';
            tr.onmouseover = () => tr.style.backgroundColor = '#f5f5f5';
            tr.onmouseout = () => tr.style.backgroundColor = '';
            
            // Columna de Edad
            const tdEdad = document.createElement('td');
            tdEdad.textContent = edadObj.label;
            tdEdad.style.padding = '12px';
            tdEdad.style.textAlign = 'center';
            tdEdad.style.fontWeight = '700';
            tdEdad.style.fontSize = '15px';
            tdEdad.style.color = '#424242';
            tdEdad.style.background = '#f8f9fa';
            tdEdad.style.verticalAlign = 'middle';
            tr.appendChild(tdEdad);
            
            // Columnas para cada tipo de ingreso
            tiposIngreso.forEach((tipo) => {
                const tdTipo = document.createElement('td');
                tdTipo.style.padding = '10px';
                tdTipo.style.verticalAlign = 'middle';
                
                tdTipo.innerHTML = `
                    <div style="display:flex;gap:8px;justify-content:center;align-items:center;">
                        <div style="flex:1;max-width:110px;">
                            <div style="display:flex;align-items:center;gap:4px;padding:6px 8px;background:#e3f2fd;border-radius:6px;border:1px solid #90caf9;margin-bottom:6px;">
                                <div style="font-weight:700;color:#1976d2;font-size:14px;min-width:20px;">M</div>
                                <input type="number" 
                                       id="input_${tipo.id}_${edadObj.id}_M" 
                                       value="" 
                                       min="0" 
                                       class="input-matricula-nueva" 
                                       data-tipo-ingreso="${tipo.id}" 
                                       data-grupo-edad="${edadObj.id}" 
                                       data-sexo="M" 
                                       style="width:100%;padding:6px 8px;border:2px solid #2196f3;border-radius:4px;background:#fff;color:#1976d2;font-weight:600;text-align:center;font-size:14px;" 
                                       placeholder="">
                            </div>
                            <div style="display:flex;align-items:center;gap:4px;padding:6px 8px;background:#fce4ec;border-radius:6px;border:1px solid #f48fb1;">
                                <div style="font-weight:700;color:#c2185b;font-size:14px;min-width:20px;">F</div>
                                <input type="number" 
                                       id="input_${tipo.id}_${edadObj.id}_F" 
                                       value="" 
                                       min="0" 
                                       class="input-matricula-nueva" 
                                       data-tipo-ingreso="${tipo.id}" 
                                       data-grupo-edad="${edadObj.id}" 
                                       data-sexo="F" 
                                       style="width:100%;padding:6px 8px;border:2px solid #e91e63;border-radius:4px;background:#fff;color:#c2185b;font-weight:600;text-align:center;font-size:14px;" 
                                       placeholder="">
                            </div>
                        </div>
                    </div>`;
                
                tr.appendChild(tdTipo);
            });
            
            tbody.appendChild(tr);
        });
        
        // Agregar fila de totales
        const trTot = document.createElement('tr');
        trTot.className = 'totales-row';
        trTot.style.borderTop = '3px solid #8B2635';
        trTot.style.backgroundColor = '#f8f9fa';
        trTot.innerHTML = `
            <td style="padding:12px;text-align:center;font-weight:700;font-size:16px;background:#8B2635;color:white;">TOTALES</td>
            <td style="padding:12px;text-align:center;" colspan="3">
                <div style="display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap;gap:15px;">
                    <div style="flex:1;min-width:120px;">
                        <div style="background:#e3f2fd;padding:8px;border-radius:8px;border:2px solid #2196f3;">
                            <div style="font-size:13px;color:#1976d2;font-weight:600;margin-bottom:4px;">Masculino</div>
                            <div id="total_masculino" style="font-size:24px;color:#1976d2;font-weight:700;">0</div>
                        </div>
                    </div>
                    <div style="flex:1;min-width:120px;">
                        <div style="background:#fce4ec;padding:8px;border-radius:8px;border:2px solid #e91e63;">
                            <div style="font-size:13px;color:#c2185b;font-weight:600;margin-bottom:4px;">Femenino</div>
                            <div id="total_femenino" style="font-size:24px;color:#c2185b;font-weight:700;">0</div>
                        </div>
                    </div>
                    <div style="flex:1;min-width:140px;">
                        <div style="background:#e8f5e9;padding:8px;border-radius:8px;border:2px solid #4caf50;">
                            <div style="font-size:13px;color:#2e7d32;font-weight:600;margin-bottom:4px;">TOTAL GENERAL</div>
                            <div id="total_general" style="font-size:26px;color:#2e7d32;font-weight:700;">0</div>
                        </div>
                    </div>
                </div>
            </td>`;
        tbody.appendChild(trTot);
        
        // Re-bind events for inputs
        const inputs = document.querySelectorAll('input.input-matricula-nueva');
        inputs.forEach(input => {
            input.addEventListener('input', calcularTotales);
            input.addEventListener('change', calcularTotales);
        });
        
        calcularTotales();
    }

    // Variables globales para manejo de turnos
    let turnosDisponibles = {{ turnos | tojson }};
    let turnoActualIndex = 0;

    // Funci√≥n para cambiar turno
    function cambiarTurno(direccion) {
        turnoActualIndex += direccion;
        
        // Validar l√≠mites
        if (turnoActualIndex < 0) turnoActualIndex = 0;
        if (turnoActualIndex >= turnosDisponibles.length) turnoActualIndex = turnosDisponibles.length - 1;
        
        // Actualizar UI
        const turnoActual = turnosDisponibles[turnoActualIndex];
        document.getElementById('turno-nombre').textContent = turnoActual.Turno;
        document.getElementById('turno').value = turnoActual.Id_Turno;
        
        // Actualizar estado de botones
        document.getElementById('btn-turno-anterior').disabled = turnoActualIndex === 0;
        document.getElementById('btn-turno-siguiente').disabled = turnoActualIndex === turnosDisponibles.length - 1;
        
        // Recargar datos con el nuevo turno
        cargarDatosExistentes();
    }

    // Funci√≥n para generar pesta√±as de semestres
    function generarPestanasSemestres(maxSemestre) {
        const tabsContainer = document.getElementById('semestres-tabs');
        tabsContainer.innerHTML = '';
        
        for (let i = 1; i <= maxSemestre; i++) {
            const tab = document.createElement('button');
            tab.className = 'semestre-tab';
            tab.textContent = `Semestre ${i}`;
            tab.setAttribute('data-semestre', i);
            tab.onclick = () => seleccionarSemestre(i);
            
            if (i === 1) {
                tab.classList.add('active');
            }
            
            tabsContainer.appendChild(tab);
        }
    }

    // Funci√≥n para seleccionar semestre
    function seleccionarSemestre(semestreNum) {
        // Actualizar tabs activas
        const tabs = document.querySelectorAll('.semestre-tab');
        tabs.forEach(tab => {
            if (parseInt(tab.getAttribute('data-semestre')) === semestreNum) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        // Actualizar campo oculto (usar el ID del semestre correspondiente)
        document.getElementById('semestre').value = semestreNum;
        
        // Recargar datos
        cargarDatosExistentes();
    }

    function guardarMatricula() {
        // Validar que al menos un campo tenga datos
        const inputs = document.querySelectorAll('input.input-matricula-nueva');
        let hasData = false;
        
        for (let input of inputs) {
            if (parseInt(input.value) > 0) {
                hasData = true;
                break;
            }
        }
        
        if (!hasData) {
            alert('‚ö†Ô∏è Por favor, ingrese al menos un valor mayor a 0 antes de guardar.');
            return;
        }

        // Validar que los filtros est√©n seleccionados
        const periodo = document.getElementById('periodo').value;
        const programa = document.getElementById('programa').value;
        const semestre = document.getElementById('semestre').value;
        const modalidad = document.getElementById('modalidad').value;
        const turno = document.getElementById('turno').value;
        
        if (!periodo || !programa || !semestre || !modalidad || !turno) {
            alert('‚ö†Ô∏è Por favor, complete todos los filtros antes de guardar.');
            return;
        }

        // Recopilar todos los datos del formulario
        const data = {
            periodo: periodo,
            programa: programa,
            semestre: semestre,
            modalidad: modalidad,
            turno: turno,
            datos_matricula: {}
        };

        // Obtener datos de cada input
        inputs.forEach(input => {
            const tipoIngreso = input.getAttribute('data-tipo-ingreso');
            const grupoEdad = input.getAttribute('data-grupo-edad');
            const sexo = input.getAttribute('data-sexo');
            const valor = parseInt(input.value) || 0;
            
            if (valor > 0) {
                const key = `${tipoIngreso}_${grupoEdad}_${sexo}`;
                data.datos_matricula[key] = {
                    tipo_ingreso: tipoIngreso,
                    grupo_edad: grupoEdad,
                    sexo: sexo,
                    matricula: valor
                };
            }
        });

        // Mostrar indicador de carga
        const saveBtn = document.querySelector('.btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '‚è≥ Guardando...';
        saveBtn.disabled = true;

        // Enviar datos al backend
        fetch('/matricula/guardar_captura_completa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.mensaje) {
                alert('‚úÖ ' + data.mensaje);
                limpiarFormulario();
            } else {
                alert('‚ùå Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al procesar la solicitud. Por favor, intente nuevamente.');
        })
        .finally(() => {
            // Restaurar bot√≥n
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        });
    }

    function limpiarFormulario() {
        const inputs = document.querySelectorAll('input.input-matricula-nueva');
        inputs.forEach(input => input.value = '0');
        calcularTotales(); // Recalcular totales despu√©s de limpiar
    }

    // Agregar eventos a los inputs para c√°lculos autom√°ticos
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar pesta√±as de semestres seg√∫n programa seleccionado
        const programaEl = document.getElementById('programa');
        if (programaEl) {
            const opt = programaEl.selectedOptions[0];
            const maxSem = parseInt(opt?.getAttribute('data-max-semestre')) || 5;
            generarPestanasSemestres(maxSem);
            
            // Actualizar pesta√±as cuando cambie el programa
            programaEl.addEventListener('change', function() {
                const opt = this.selectedOptions[0];
                const maxSem = parseInt(opt?.getAttribute('data-max-semestre')) || 5;
                generarPestanasSemestres(maxSem);
                seleccionarSemestre(1); // Resetear a semestre 1
            });
        }
        
        // Inicializar turno
        if (turnosDisponibles && turnosDisponibles.length > 0) {
            document.getElementById('turno-nombre').textContent = turnosDisponibles[0].Turno;
            document.getElementById('turno').value = turnosDisponibles[0].Id_Turno;
            document.getElementById('btn-turno-anterior').disabled = true;
            document.getElementById('btn-turno-siguiente').disabled = turnosDisponibles.length <= 1;
        }
        
        // Agregar eventos a los filtros para cargar datos existentes
        const filtros = ['periodo', 'programa', 'modalidad'];
        filtros.forEach(filtroId => {
            const elemento = document.getElementById(filtroId);
            if (elemento) {
                elemento.addEventListener('change', cargarDatosExistentes);
            }
        });

        // Generar tabla vac√≠a inicial
        generarTablaVacia();
        
        // Cargar datos existentes desde el SP para poblar la vista al inicio
        cargarDatosExistentes();
        
        // Calcular totales iniciales
        calcularTotales();
    });
</script>
<!-- Panel debug opcional para ver filas crudas del SP -->
<div id="sp-debug-panel" style="margin:20px; padding:10px; border:1px solid #ddd; display:none;">
    <h4>Debug SP - Filas crudas</h4>
    <div id="sp-debug-content">(vacio)</div>
</div>
<script>
    // Funci√≥n para renderizar rows devueltas por el backend (para debug)
    function renderSPRows(rows) {
        const panel = document.getElementById('sp-debug-panel');
        const content = document.getElementById('sp-debug-content');
        if (!rows || !rows.length) {
            panel.style.display = 'none';
            return;
        }
        panel.style.display = 'block';
        // Construir tabla HTML
        const cols = Object.keys(rows[0]);
        let html = '<table style="width:100%; border-collapse:collapse;">';
        html += '<thead><tr>' + cols.map(c => `<th style="border:1px solid #ccc;padding:6px;background:#f5f5f5;">${c}</th>`).join('') + '</tr></thead>';
        html += '<tbody>';
        rows.forEach(r => {
            html += '<tr>' + cols.map(c => `<td style="border:1px solid #eee;padding:6px;">${(r[c] === null || r[c] === undefined) ? '' : r[c]}</td>`).join('') + '</tr>';
        });
        html += '</tbody></table>';
        content.innerHTML = html;
    }
</script>
{% endblock %}

{% endblock %}
